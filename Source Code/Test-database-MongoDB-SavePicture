from pymongo import MongoClient
import gridfs

# ----------------------------
# 1️⃣ Connect to MongoDB Atlas
# ----------------------------
client = MongoClient("mongodb+srv://thomaslemee:43FQtXdLIpTI6TMj@cluster0.ltebrpg.mongodb.net/")
db = client["Cluster0"]  # Database name
fs = gridfs.GridFS(db)   # I am using GridFS to store large files like images

# ----------------------------
# 2️⃣ Upload an image to MongoDB
# ----------------------------
image_path = r"C:\Users\retir\OneDrive - Groupe INSEEC (POCE)\Images\JAUGE.jpg"

with open(image_path, "rb") as f:
    data = f.read()  # I read the image in binary mode

file_id = fs.put(data, filename="JAUGE.jpg")  # I store the image in MongoDB
print("Image stored in MongoDB with ID:", file_id)

# ----------------------------
# 3️⃣ Retrieve the image from MongoDB
# ----------------------------
file = fs.find_one({"filename": "JAUGE.jpg"})  # I retrieve the image by filename

output_path = r"C:\Users\retir\OneDrive - Groupe INSEEC (POCE)\Images\JAUGE_recuperee1.jpg"

with open(output_path, "wb") as f:
    f.write(file.read())  # I write the image bytes to a new file locally

print("Image retrieved from MongoDB and saved locally at:", output_path)


# ============================================================
# Explanation of what I did and how I ran MongoDB
# ============================================================

# 1. Setting up MongoDB Atlas:
# I created an account on MongoDB Atlas and set up a cluster called "Cluster0".
# I added my PC's IP address to Network Access so I could connect from Python.
# I created a database user called 'thomaslemee' with a password and gave it read/write access.

# 2. Running MongoDB:
# Since I am using MongoDB Atlas, I don't need to run a local MongoDB server.
# The cluster is always online in the cloud. My Python script connects directly to it.

# 3. Connecting from Python:
# I imported MongoClient from pymongo and GridFS.
# Using MongoClient(MONGO_URI), I connected to my cluster.
# I selected the database with db = client["Cluster0"].
# I initialized GridFS with fs = GridFS(db) so I could store and retrieve large files.

# 4. Storing the image:
# I opened my local image in binary mode to read all bytes.
# I used fs.put(data, filename="JAUGE.jpg") to store it in MongoDB.
# GridFS automatically handles splitting the file into chunks for storage.

# 5. Retrieving the image:
# I used fs.find_one({"filename": "JAUGE.jpg"}) to get the file from MongoDB.
# I wrote the bytes to a new file on my PC called JAUGE_recuperee1.jpg.
# This shows that I can send files to MongoDB and retrieve them back.

# 6. Running the script:
# I made sure Python is installed on my PC.
# I installed pymongo using pip install pymongo.
# I saved this script and ran it using python script_name.py in a terminal or Spyder.
# The print statements confirm that the upload and download worked correctly.

# 7. File paths:
# image_path points to the original image I want to store.
# output_path is where I save the retrieved image on my PC.
# I made sure both directories exist to avoid errors.
